# Configuring Rate Limiting and IP Restriction in Kong Ingress
_Date: 2025-12-12_

Today I learned how to configure **Kong plugins** in a clean and modular way using `KongPlugin` in conjunction with `Ingress` on Kubernetes.

These configurations allow you to control request limits per consumer and restrict access by IP ranges â€” something essential for internal or sensitive APIs.

## ğŸ›ï¸ Creating plugins as separate objects

Instead of configuring plugins directly in Ingress, I learned that the recommended practice is to create independent KongPlugin objects:

- This makes everything more organized.
- It avoids repeating configuration in multiple ingress.
- It makes it easier to track and version changes.

Example (rate limiting and IP restriction):

```yaml
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: test-rate-limiting-plugin
  namespace: test
plugin: rate-limiting
config:
  policy: local
  limit_by: consumer
  second: 200
  hide_client_headers: false
  fault_tolerant: true
---
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: test-ip-restriction-plugin
  namespace: test
plugin: ip-restriction
config:
  allow:
    - 199.199.0.0/99
    - 1999:17ff::/10
```

## ğŸ”—  Attaching plugins via annotation in Ingress

Plugins only become valid when referenced in `Ingress`:

```yaml
konghq.com/plugins: test-rate-limiting-plugin, test-ip-restriction-plugin
```

This causes Kong to associate these plugins with the internal *routes* generated by the controller.


## ğŸ“ Using exact paths in Ingress

I configured Ingress with an exact pathâ€”which prevents unexpected coincidences in routes:

```yaml
paths:
  - path: /meu/endpoint/exato
```

This ensures that **only** the correct endpoint is exposed.

## ğŸš« Understanding `strip-path: â€œfalseâ€`

I learned that:

- `strip-path=true` removes the path prefix before sending it to the backend.
- `strip-path=false` keeps the path exactly as the client sent it.

In my case, the backend needed the full path (to restrict to a specific endpoint) â€” so:

```yaml
konghq.com/strip-path: "false"
```

## ğŸ§  What really made everything â€œclickâ€

The most important part that I internalized:

- Plugins live **separately** as CRDs.
- They only work when **referenced** in Ingress.
- Ingress controls the behavior of the route in Kong.
- `strip-path` directly influences how the backend will receive requests.

## âœ”ï¸ Conclusion

In the end, I set up a standardized configuration that was clear and fully aligned with Kong Ingress Controller best practices. 

